"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e={_default:{name:"Model",useSessions:!1,deserializeTactic:"always",extract:"body",clientType:"client",selfInit:!1,getUser:(e,t)=>t(null,{}),verify:(e,t,s)=>s(null,!0),serialize:(e,t)=>t(null,e),deserialize:(e,t)=>t(null,e),initOnError:{status:500},initOnSuccess:null,authenticateOnError:{status:500},authenticateOnFail:{status:401},authenticateOnSuccess:null,checkAuthenticationOnFail:{status:401},checkAuthenticationOnSuccess:null,checkAuthenticatedOnFail:{status:401},checkAuthenticatedOnSuccess:null,checkUnauthenticatedOnFail:{status:401},checkUnauthenticatedOnSuccess:null,logoutOnSuccess:null,deserializeUserOnError:{status:500},deserializeUserOnSuccess:null}},t=e=>(t,s)=>s.sendStatus(e),s=(e,s)=>{if("function"==typeof e)return e;if("object"!=typeof e)throw new Error(`Invalid ${s} input, type ${typeof e} - ${e}`);if(e.redirect)return n=e.redirect,(e,t)=>t.redirect(n);var n,i,r;if(e.send)return i=e.send,(e,t)=>t.send(i);if(e.json)return r=e.json,(e,t)=>t.json(r);if(e.status)return t(e.status);if(e.sendStatus)return t(e.sendStatus);throw new Error(`Invalid ${s} input`)},n=(t,s,n)=>{const i=((t,s)=>{if(t&&!e[t])throw new Error("model is not set");return{...e[t||"_default"],...s}})(t,s);return((e,t)=>{e.onFail&&(e[`${t}OnFail`]=e.onFail),e.onError&&(e[`${t}OnError`]=e.onError),e.onSuccess&&(e[`${t}OnSuccess`]=e.onSuccess)})(i,n),(e=>{if("function"!=typeof e.verify)throw new Error("verify must be a function");if("function"!=typeof e.getUser)throw new Error("getUser must be a function")})(i),i},i=e=>{const{serialize:t}=e;return(e,s,n)=>{t(e.deserializedUser,(t,s)=>{e.jazzy.user=s,e.session.jazzy=e.jazzy,n()})}},r=(e,t,s,n)=>{n.deserializedUser=null,s(null,(function(e){if(this.deserializedUser)return e(null,this.deserializedUser);t(this.jazzy.user,(t,s)=>{this.deserializedUser=s,e(t,s)})}))},u=e=>t=>t(null,e),a=(e,t,s)=>{t(e,s)},c=e=>e,l=(e,t)=>{"object"==typeof e&&(t=e,e=null);const i=n(e,t,"init");if(!i.useSessions)return(e=>{if(e.initOnSuccess){const t=s(e.initOnSuccess,"initOnSuccess");return(e,s,n)=>{e.jazzy={isAuthenticated:!1},t(e,s,n)}}return(e,t,s)=>{e.jazzy={isAuthenticated:!1,auth:{}},s()}})(i);const{deserialize:u}=i,c=s(i.initOnError,"initOnError"),l="always"===i.deserializeTactic?a:r,o=(e,t,s)=>{e.session.jazzy?(e.jazzy=e.session.jazzy,e.jazzy.user?l(e.jazzy.user,u,(n,i)=>{n&&c(e,t,n,s),e.user=i,s()},e):s()):(e.jazzy={isAuthenticated:!1,auth:{}},e.session.jazzy=e.jazzy,s())};return i.initOnSuccess?[o,s(i.initOnSuccess,"initOnSuccess")]:o};exports.authenticate=(e,t)=>{"object"==typeof e&&(t=e,e=null);const r=n(e,t,"authenticate"),{verify:a,getUser:o,clientType:d,name:h,deserialize:z}=r,f=(e=>"function"==typeof e?e:(t,s)=>s(null,t[e]))(r.extract),O=s(r.authenticateOnError,"authenticateOnError"),y=s(r.authenticateOnFail,"authenticateOnFail"),S="always"===r.deserializeTactic?c:u,p=(e,t,s)=>{f(e,(n,i)=>n?O(e,t,n,s):i?void o(i,(n,r)=>n?O(e,t,n,s):r?void a(i,r,(n,u)=>n?O(e,t,n,s):u?(e.jazzy.auth[h]={clientType:d,query:i,model:h,result:u},e.jazzy.isAuthenticated=!0,e.user=S(r,z),e.deserializedUser=r,void s()):y(e,t),e):y(e,t),e):y(e,t))},j=[];return r.selfInit&&j.push(l(r)),j.push(p),r.useSessions&&j.push(i(r)),r.authenticateOnSuccess&&j.push(s(r.authenticateOnSuccess,"authenticateOnSuccess")),1===j.length?p:j},exports.checkAuthenticated=(e,t)=>((e,t,i)=>{"object"==typeof e&&(t=e,e=null);const r=`${i}OnFail`,u=`${i}OnSuccess`,a=n(e,t,i),c=s(a[r],r);if(!a[u])return(e,t,s)=>{if(e.jazzy.isAuthenticated)return s();c(e,t)};const l=s(a[u],u);return(e,t,s)=>{if(e.jazzy.isAuthenticated)return l(e,t,s);c(e,t)}})(e,t,"checkAuthenticated"),exports.checkUnauthenticated=(e,t)=>((e,t,i)=>{"object"==typeof e&&(t=e,e=null);const r=`${i}OnFail`,u=`${i}OnSuccess`,a=n(e,t,i),c=s(a[r],r);if(!a[u])return(e,t,s)=>{if(!e.jazzy.isAuthenticated)return s();c(e,t)};const l=s(a[u],u);return(e,t,s)=>{if(!e.jazzy.isAuthenticated)return l(e,t,s);c(e,t)}})(e,t,"checkUnauthenticated"),exports.defineModel=(t,s,n)=>{if("object"==typeof t){if(n=s,!(s=t).name)throw new Error("Model must have a name");t=t.name}e[t]={name:"Model",useSessions:!1,deserializeTactic:"always",extract:"body",clientType:"client",selfInit:!1,getUser:(e,t)=>t(null,{}),verify:(e,t,s)=>s(null,!0),serialize:(e,t)=>t(null,e),deserialize:(e,t)=>t(null,e),initOnError:{status:500},initOnSuccess:null,authenticateOnError:{status:500},authenticateOnFail:{status:401},authenticateOnSuccess:null,checkAuthenticationOnFail:{status:401},checkAuthenticationOnSuccess:null,checkAuthenticatedOnFail:{status:401},checkAuthenticatedOnSuccess:null,checkUnauthenticatedOnFail:{status:401},checkUnauthenticatedOnSuccess:null,logoutOnSuccess:null,deserializeUserOnError:{status:500},deserializeUserOnSuccess:null,...s},e[t].name=t,e[t].isDefault=n,n&&(e._default=e[t])},exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const i=n(e,t,"deserializeUser"),r=s(i.deserializeUserOnError,"deserializeUserOnError"),u=(e,t,s)=>{if(!e.user)return s();e.user(e=>{if(e)return r();s()})};return i.deserializeUserOnSuccess?[u,s(i.deserializeUserOnSuccess,"deserializeUserOnSuccess")]:u},exports.init=l,exports.initiate=l,exports.logout=(e,t)=>{"object"==typeof e&&(t=e,e=null);const i=n(e,t,"logout");if(!i.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const r=(e,t,s)=>{delete e.user,e.jazzy={isAuthenticated:!1,auth:{}},e.session.jazzy=e.jazzy,s()};return i.logoutOnSuccess?[r,s(i.logoutOnSuccess,"logoutOnSuccess")]:r},exports.models=e,exports.modifyModel=(t,s)=>{if(!e[t])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:n}=e[t];Object.assign(e[t],s),e[t].isDefault=n},exports.saveSession=i;
